############################################
# Dragon Mod - Character Interactions
# File: common/character_interactions/dragon_expanded_interactions.txt
############################################

##########
# CHALLENGE TO DRAGON DUEL
# Challenge another dragon rider to aerial combat
##########
challenge_dragon_duel_interaction = {
	interface_priority = 60
	common_interaction = yes
	category = interaction_category_hostile
	
	desc = challenge_dragon_duel_interaction_desc
	
	is_shown = {
		scope:actor = {
			has_dragon_rider_trigger = yes
			has_dragon_equipped_trigger = yes
		}
		scope:recipient = {
			has_dragon_rider_trigger = yes
			has_dragon_equipped_trigger = yes
			NOT = { this = scope:actor }
		}
	}
	
	is_valid_showing_failures_only = {
		scope:actor = {
			is_available = yes
			is_adult = yes
			NOT = { is_at_war_with = scope:recipient }
		}
		scope:recipient = {
			is_available = yes
			is_adult = yes
		}
	}
	
	cooldown = { years = 5 }
	cooldown_against_recipient = { years = 10 }
	
	on_accept = {
		scope:actor = {
			trigger_event = dragon_interactions.0001
		}
	}
	
	on_decline = {
		scope:actor = {
			send_interface_message = {
				type = event_generic_neutral
				title = challenge_dragon_duel_declined_title
				desc = challenge_dragon_duel_declined_desc
				
				scope:recipient = {
					add_prestige = -100
					add_character_modifier = {
						modifier = refused_dragon_duel_modifier
						years = 5
					}
				}
			}
		}
	}
	
	ai_accept = {
		base = 0
		
		# Brave characters more likely to accept
		modifier = {
			add = 50
			scope:recipient = { has_trait = brave }
		}
		
		# Prideful characters won't refuse
		modifier = {
			add = 30
			scope:recipient = { has_trait = arrogant }
		}
		
		# Craven characters refuse
		modifier = {
			add = -100
			scope:recipient = { has_trait = craven }
		}
		
		# Higher prowess = more confident
		modifier = {
			add = 20
			scope:recipient = {
				prowess >= scope:actor.prowess
			}
		}
		
		# Lower prowess = less confident
		modifier = {
			add = -30
			scope:recipient = {
				prowess < scope:actor.prowess
			}
		}
		
		# Rivalry increases acceptance
		modifier = {
			add = 40
			scope:recipient = {
				has_relation_rival = scope:actor
			}
		}
	}
	
	ai_potential = {
		is_adult = yes
		has_dragon_rider_trigger = yes
		has_dragon_equipped_trigger = yes
	}
	
	ai_targets = {
		ai_recipients = neighboring_rulers
	}
	
	ai_frequency = 24
	
	ai_will_do = {
		base = 0
		
		modifier = {
			add = 25
			has_trait = brave
		}
		
		modifier = {
			add = 25
			has_trait = ambitious
		}
		
		modifier = {
			add = 50
			has_relation_rival = scope:recipient
		}
		
		modifier = {
			factor = 0
			has_trait = craven
		}
	}
}

##########
# GIFT DRAGON EGG
# Gift a dragon egg to another character
##########
gift_dragon_egg_interaction = {
	interface_priority = 50
	common_interaction = yes
	category = interaction_category_friendly
	
	desc = gift_dragon_egg_interaction_desc
	
	is_shown = {
		scope:actor = {
			has_dragon_trigger = yes
			# Must have egg - using trait as marker
			OR = {
				has_trait = dragon_egg_owner
				any_character_artifact = {
					has_variable = is_dragon_egg
				}
			}
		}
		scope:recipient = {
			NOT = { this = scope:actor }
			is_adult = yes
		}
	}
	
	is_valid_showing_failures_only = {
		scope:actor = {
			is_available = yes
		}
		scope:recipient = {
			is_available = yes
			NOT = { has_dragon_trigger = yes }
		}
	}
	
	cooldown_against_recipient = { years = 20 }
	
	on_accept = {
		scope:actor = {
			# Remove egg from actor
			if = {
				limit = { has_trait = dragon_egg_owner }
				remove_trait = dragon_egg_owner
			}
			
			# Give egg to recipient
			scope:recipient = {
				add_trait = dragon_egg_owner
				add_character_modifier = {
					modifier = dragon_egg_gifted_modifier
					years = 10
				}
			}
			
			# Opinion boost
			reverse_add_opinion = {
				target = scope:recipient
				modifier = grateful_opinion
				opinion = 50
			}
			
			add_prestige = 200
			
			trigger_event = dragon_interactions.0010
		}
	}
	
	ai_accept = {
		base = 100  # Always accept a dragon egg gift
	}
	
	ai_potential = {
		has_dragon_trigger = yes
		OR = {
			has_trait = dragon_egg_owner
			any_character_artifact = {
				has_variable = is_dragon_egg
			}
		}
	}
	
	ai_targets = {
		ai_recipients = family
		ai_recipients = vassals
		ai_recipients = liege
	}
	
	ai_frequency = 60
	
	ai_will_do = {
		base = 0
		
		# Gift to heirs
		modifier = {
			add = 50
			scope:recipient = {
				is_heir_of = scope:actor
			}
		}
		
		# Gift to children
		modifier = {
			add = 30
			scope:recipient = {
				is_child_of = scope:actor
			}
		}
		
		# Gift to spouse
		modifier = {
			add = 20
			scope:recipient = {
				is_spouse_of = scope:actor
			}
		}
		
		# Generous characters more likely
		modifier = {
			add = 20
			scope:actor = { has_trait = generous }
		}
	}
}

##########
# DEMAND DRAGON TRIBUTE
# Demand tribute from a non-dragon-riding neighbor
##########
demand_dragon_tribute_interaction = {
	interface_priority = 55
	common_interaction = yes
	category = interaction_category_hostile
	
	desc = demand_dragon_tribute_interaction_desc
	
	is_shown = {
		scope:actor = {
			has_dragon_rider_trigger = yes
			has_dragon_equipped_trigger = yes
			is_landed = yes
		}
		scope:recipient = {
			is_landed = yes
			NOT = { has_dragon_rider_trigger = yes }
			NOT = { this = scope:actor }
			# Must be neighbor or vassal
			OR = {
				is_vassal_of = scope:actor
				any_neighboring_realm_same_rank_owner = {
					this = scope:actor
				}
			}
		}
	}
	
	is_valid_showing_failures_only = {
		scope:actor = {
			is_available = yes
		}
		scope:recipient = {
			is_available = yes
			gold >= 100
		}
	}
	
	cooldown_against_recipient = { years = 3 }
	
	on_accept = {
		scope:recipient = {
			pay_short_term_gold = {
				target = scope:actor
				gold = 200
			}
			
			add_character_modifier = {
				modifier = dragon_tribute_paid_modifier
				years = 3
			}
		}
		
		scope:actor = {
			add_dread = 15
			add_prestige = 100
			
			trigger_event = dragon_interactions.0020
		}
	}
	
	on_decline = {
		scope:actor = {
			# Recipient refuses - consequences
			add_opinion = {
				target = scope:recipient
				modifier = angry_opinion
				opinion = -30
			}
			
			# Can be used as casus belli
			add_character_flag = {
				flag = tribute_refused_by_@scope:recipient
				years = 10
			}
			
			trigger_event = dragon_interactions.0021
		}
	}
	
	ai_accept = {
		base = 0
		
		# Fear of dragons
		modifier = {
			add = 50
			scope:recipient = {
				culture = {
					has_cultural_tradition = tradition_dragon_fearers
				}
			}
		}
		
		# Dragon tributaries culture
		modifier = {
			add = 75
			scope:recipient = {
				culture = {
					has_cultural_tradition = tradition_dragon_tributaries
				}
			}
		}
		
		# Power differential
		modifier = {
			add = 30
			scope:actor = {
				tier_difference = {
					target = scope:recipient
					value >= 1
				}
			}
		}
		
		# Dragonslayers refuse
		modifier = {
			add = -100
			scope:recipient = {
				culture = {
					has_cultural_tradition = tradition_dragonslayers
				}
			}
		}
		
		# Brave characters refuse
		modifier = {
			add = -30
			scope:recipient = { has_trait = brave }
		}
		
		# Craven characters comply
		modifier = {
			add = 40
			scope:recipient = { has_trait = craven }
		}
	}
	
	ai_potential = {
		is_landed = yes
		has_dragon_rider_trigger = yes
		has_dragon_equipped_trigger = yes
	}
	
	ai_targets = {
		ai_recipients = neighboring_rulers
		ai_recipients = vassals
	}
	
	ai_frequency = 36
	
	ai_will_do = {
		base = 10
		
		modifier = {
			add = 30
			has_trait = greedy
		}
		
		modifier = {
			add = 20
			has_trait = ambitious
		}
		
		modifier = {
			add = 20
			gold < 200
		}
		
		modifier = {
			factor = 0
			has_trait = generous
		}
	}
}

##########
# REQUEST DRAGON TRAINING
# Ask a dragon rider to train you/your child
##########
request_dragon_training_interaction = {
	interface_priority = 45
	common_interaction = yes
	category = interaction_category_friendly
	
	desc = request_dragon_training_interaction_desc
	
	is_shown = {
		scope:actor = {
			is_adult = yes
			NOT = { has_dragon_rider_trigger = yes }
			culture = {
				has_cultural_pillar = heritage_arick
			}
		}
		scope:recipient = {
			has_dragon_rider_trigger = yes
			NOT = { this = scope:actor }
		}
	}
	
	is_valid_showing_failures_only = {
		scope:actor = {
			is_available = yes
			gold >= 50
			prestige >= 100
		}
		scope:recipient = {
			is_available = yes
		}
	}
	
	send_option = {
		is_shown = {
			scope:actor = {
				any_child = {
					age >= 6
					age <= 16
					NOT = { has_dragon_rider_trigger = yes }
				}
			}
		}
		flag = train_child
		localization = request_dragon_training_for_child
	}
	
	cooldown_against_recipient = { years = 10 }
	
	cost = {
		gold = {
			value = 100
		}
		prestige = {
			value = 100
		}
	}
	
	on_accept = {
		scope:actor = {
			# If training self
			if = {
				limit = {
					NOT = { scope:train_child = yes }
				}
				add_trait = dragon_squire
				custom_tooltip = dragon_training_begun_tt
			}
			# If training child
			else = {
				random_child = {
					limit = {
						age >= 6
						age <= 16
						NOT = { has_dragon_rider_trigger = yes }
					}
					add_trait = dragon_squire
					custom_tooltip = child_dragon_training_begun_tt
				}
			}
			
			reverse_add_opinion = {
				target = scope:recipient
				modifier = grateful_opinion
				opinion = 20
			}
			
			trigger_event = dragon_interactions.0030
		}
	}
	
	on_decline = {
		scope:actor = {
			send_interface_message = {
				type = event_generic_neutral
				title = dragon_training_refused_title
				desc = dragon_training_refused_desc
			}
		}
	}
	
	ai_accept = {
		base = 0
		
		# Family gets priority
		modifier = {
			add = 50
			scope:recipient = {
				is_close_or_extended_family_of = scope:actor
			}
		}
		
		# Same culture
		modifier = {
			add = 25
			scope:actor = {
				culture = scope:recipient.culture
			}
		}
		
		# Opinion matters
		opinion_modifier = {
			opinion_target = scope:actor
			multiplier = 0.5
		}
		
		# Kind characters help
		modifier = {
			add = 20
			scope:recipient = { has_trait = compassionate }
		}
		
		# Greedy characters want payment
		modifier = {
			add = 30
			scope:recipient = { has_trait = greedy }
		}
	}
	
	ai_potential = {
		is_adult = yes
		NOT = { has_dragon_rider_trigger = yes }
		culture = {
			has_cultural_pillar = heritage_arick
		}
	}
	
	ai_targets = {
		ai_recipients = dynasty
		ai_recipients = liege
	}
	
	ai_frequency = 60
	
	ai_will_do = {
		base = 20
		
		modifier = {
			add = 30
			has_trait = ambitious
		}
		
		modifier = {
			add = 20
			any_child = {
				age >= 6
				age <= 12
			}
		}
	}
}

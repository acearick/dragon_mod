create_artifact_dragon_egg_effect = {
	# Get the character the artifact is being made for.
	$OWNER$ = { save_scope_as = owner }
	# Not really used, but if we don't set the scopes we get errors in the feature selection
	set_artifact_rarity_illustrious = yes

	# Create the artifact
	create_artifact = {
		name = artifact_dragon_egg_name
		description = artifact_dragon_egg
		type = dragon_egg
		template = dragon_egg_template
		visuals = dragon_egg_visual
		wealth = scope:wealth
		quality = scope:quality
		modifier = dragon_egg_modifier
		save_scope_as = newly_created_artifact
		decaying = no
		history = {
			location = root.capital_province
			actor = root
			recipient = root
			type = discovered
		}
	}

	scope:newly_created_artifact = {
		set_variable = { # Tracks age
			name = egg_age
			value = 0
		}
		set_variable = { # Marker for egg identification
			name = is_dragon_egg
			value = yes
		}
	}
}

create_artifact_hatchling_dragon_effect = {
	# Get the character the artifact is being made for.
	$OWNER$ = { save_scope_as = owner }
	# Not really used, but if we don't set the scopes we get errors in the feature selection
	set_artifact_rarity_illustrious = yes

	# Create the artifact
	create_artifact = {
		name = artifact_dragon_name
		description = artifact_hatchling_dragon
		type = type_hatchling_dragon
		template = dragon_template
		visuals = hatchling_dragon_visual
		wealth = scope:wealth
		quality = scope:quality
		modifier = new_dragon_modifier
		save_scope_as = newly_created_artifact
		decaying = no
		history = {
			location = root.capital_province
			actor = root
			recipient = root
			type = discovered
		}
	}

	scope:newly_created_artifact = {
		set_variable = { # Tracks age
			name = hatchling_dragon_age
			value = 0
		}
	}
}

create_artifact_adolescent_dragon_effect = {
	# Get the character the artifact is being made for.
	$OWNER$ = { save_scope_as = owner }
	# $DRAGON_NAME$ = { save_scope_as = dragon_name }
	# Not really used, but if we don't set the scopes we get errors in the feature selection
	set_artifact_rarity_illustrious = yes

	# Create the artifact
	create_artifact = {
		name = artifact_adolescent_dragon_name
		description = artifact_adolescent_dragon
		type = type_adolescent_dragon
		template = dragon_template
		visuals = adolescent_dragon_visual
		wealth = scope:wealth
		quality = scope:quality
		modifier = new_dragon_modifier
		save_scope_as = newly_created_artifact
		decaying = no
		history = {
			location = root.capital_province
			actor = root
			recipient = root
			type = discovered
		}
	}

	scope:newly_created_artifact = {
		set_variable = { # Tracks age
			name = adolescent_dragon_age
			value = 0
		}
	}
}

create_artifact_young_dragon_effect = {
	# Get the character the artifact is being made for.
	$OWNER$ = { save_scope_as = owner }
	# Not really used, but if we don't set the scopes we get errors in the feature selection
	set_artifact_rarity_illustrious = yes

	# Create the artifact
	create_artifact = {
		name = artifact_young_dragon_name
		description = artifact_young_dragon
		type = type_young_dragon
		template = dragon_template
		visuals = young_dragon_visual
		wealth = scope:wealth
		quality = scope:quality
		modifier = new_dragon_modifier
		save_scope_as = newly_created_artifact
		decaying = no
		history = {
			location = root.capital_province
			actor = root
			recipient = root
			type = discovered
		}
	}

	scope:newly_created_artifact = {
		set_variable = { # Tracks age
			name = young_dragon_age
			value = 0
		}
	}
}

create_artifact_adult_dragon_effect = {
	# Get the character the artifact is being made for.
	$OWNER$ = { save_scope_as = owner }
	# Not really used, but if we don't set the scopes we get errors in the feature selection
	set_artifact_rarity_illustrious = yes

	# Create the artifact
	create_artifact = {
		name = artifact_adult_dragon_name
		description = artifact_adult_dragon
		type = type_adult_dragon
		template = dragon_template
		visuals = adult_dragon_visual
		wealth = scope:wealth
		quality = scope:quality
		modifier = new_dragon_modifier
		save_scope_as = newly_created_artifact
		decaying = no
		history = {
			location = root.capital_province
			actor = root
			recipient = root
			type = discovered
		}
	}

	scope:newly_created_artifact = {
		set_variable = { # Tracks age
			name = adult_dragon_age
			value = 0
		}
	}
}

create_artifact_ancient_dragon_effect = {
	# Get the character the artifact is being made for.
	$OWNER$ = { save_scope_as = owner }
	# Not really used, but if we don't set the scopes we get errors in the feature selection
	set_artifact_rarity_illustrious = yes

	# Create the artifact
	create_artifact = {
		name = artifact_ancient_dragon_name
		description = artifact_ancient_dragon
		type = type_ancient_dragon
		template = dragon_template
		visuals = ancient_dragon_visual
		wealth = scope:wealth
		quality = scope:quality
		modifier = new_dragon_modifier
		save_scope_as = newly_created_artifact
		decaying = no
		history = {
			location = root.capital_province
			actor = root
			recipient = root
			type = discovered
		}
	}

	scope:newly_created_artifact = {
		set_variable = { name = historical_unique_artifact value = yes }
		save_scope_as = epic
	}
}

# ═══════════════════════════════════════════
# ELDER DRAGON CREATION
# ═══════════════════════════════════════════

create_artifact_elder_dragon_effect = {
	$OWNER$ = { save_scope_as = owner }
	set_artifact_rarity_illustrious = yes

	create_artifact = {
		name = artifact_elder_dragon_name
		description = artifact_elder_dragon_desc
		type = type_elder_dragon
		template = dragon_template
		visuals = elder_dragon_visual
		wealth = scope:wealth
		quality = scope:quality
		modifier = dragon_elder_modifier
		save_scope_as = newly_created_artifact
		decaying = no
		history = {
			location = root.capital_province
			actor = root
			recipient = root
			type = discovered
		}
	}

	scope:newly_created_artifact = {
		set_variable = {
			name = dragon_age
			value = 151
		}
		set_variable = {
			name = dragon_stage
			value = flag:elder
		}
	}
}

# ═══════════════════════════════════════════
# PRIMORDIAL DRAGON CREATION
# ═══════════════════════════════════════════

create_artifact_primordial_dragon_effect = {
	$OWNER$ = { save_scope_as = owner }
	set_artifact_rarity_illustrious = yes

	create_artifact = {
		name = artifact_primordial_dragon_name
		description = artifact_primordial_dragon_desc
		type = type_primordial_dragon
		template = dragon_template
		visuals = primordial_dragon_visual
		wealth = scope:wealth
		quality = scope:quality
		modifier = dragon_primordial_modifier
		save_scope_as = newly_created_artifact
		decaying = no
		history = {
			location = root.capital_province
			actor = root
			recipient = root
			type = discovered
		}
	}

	scope:newly_created_artifact = {
		set_variable = {
			name = dragon_age
			value = 301
		}
		set_variable = {
			name = dragon_stage
			value = flag:primordial
		}
		set_variable = {
			name = historical_unique_artifact
			value = yes
		}
		save_scope_as = epic
	}
}

# ═══════════════════════════════════════════
# DRAGON RELIC CREATION EFFECTS
# Used when a dragon dies
# ═══════════════════════════════════════════

create_dragon_skull_effect = {
	$OWNER$ = { save_scope_as = owner }
	set_artifact_rarity_illustrious = yes

	create_artifact = {
		name = artifact_dragon_skull_name
		description = artifact_dragon_skull_desc
		type = type_dragon_skull
		template = dragon_egg_template
		visuals = dragon_skull_visual
		wealth = scope:wealth
		quality = scope:quality
		modifier = dragon_skull_modifier
		save_scope_as = newly_created_artifact
		decaying = no
		history = {
			location = root.capital_province
			actor = root
			recipient = root
			type = created
		}
	}

	# Transfer element from dead dragon
	if = {
		limit = { exists = scope:dead_dragon }
		scope:newly_created_artifact = {
			if = {
				limit = { scope:dead_dragon = { has_artifact_feature = dragon_element_fire } }
				add_artifact_feature = dragon_element_fire
			}
			else_if = {
				limit = { scope:dead_dragon = { has_artifact_feature = dragon_element_water } }
				add_artifact_feature = dragon_element_water
			}
			else_if = {
				limit = { scope:dead_dragon = { has_artifact_feature = dragon_element_stone } }
				add_artifact_feature = dragon_element_stone
			}
		}
	}
}

create_dragon_bones_effect = {
	$OWNER$ = { save_scope_as = owner }
	set_artifact_rarity_famed = yes

	create_artifact = {
		name = artifact_dragon_bones_name
		description = artifact_dragon_bones_desc
		type = type_dragon_bones
		template = dragon_egg_template
		visuals = dragon_bones_visual
		wealth = scope:wealth
		quality = scope:quality
		modifier = dragon_bones_modifier
		save_scope_as = newly_created_artifact
		decaying = no
		history = {
			location = root.capital_province
			actor = root
			recipient = root
			type = created
		}
	}

	if = {
		limit = { exists = scope:dead_dragon }
		scope:newly_created_artifact = {
			if = {
				limit = { scope:dead_dragon = { has_artifact_feature = dragon_element_fire } }
				add_artifact_feature = dragon_element_fire
			}
			else_if = {
				limit = { scope:dead_dragon = { has_artifact_feature = dragon_element_water } }
				add_artifact_feature = dragon_element_water
			}
			else_if = {
				limit = { scope:dead_dragon = { has_artifact_feature = dragon_element_stone } }
				add_artifact_feature = dragon_element_stone
			}
		}
	}
}

create_dragon_heart_effect = {
	$OWNER$ = { save_scope_as = owner }
	set_artifact_rarity_illustrious = yes

	create_artifact = {
		name = artifact_dragon_heart_name
		description = artifact_dragon_heart_desc
		type = type_dragon_heart
		template = dragon_egg_template
		visuals = dragon_heart_visual
		wealth = scope:wealth
		quality = scope:quality
		modifier = dragon_heart_modifier
		save_scope_as = newly_created_artifact
		decaying = no
		history = {
			location = root.capital_province
			actor = root
			recipient = root
			type = created
		}
	}

	if = {
		limit = { exists = scope:dead_dragon }
		scope:newly_created_artifact = {
			if = {
				limit = { scope:dead_dragon = { has_artifact_feature = dragon_element_fire } }
				add_artifact_feature = dragon_element_fire
			}
			else_if = {
				limit = { scope:dead_dragon = { has_artifact_feature = dragon_element_water } }
				add_artifact_feature = dragon_element_water
			}
			else_if = {
				limit = { scope:dead_dragon = { has_artifact_feature = dragon_element_stone } }
				add_artifact_feature = dragon_element_stone
			}
		}
	}
}

create_dragonscale_cloak_effect = {
	$OWNER$ = { save_scope_as = owner }
	set_artifact_rarity_illustrious = yes

	create_artifact = {
		name = artifact_dragonscale_cloak_name
		description = artifact_dragonscale_cloak_desc
		type = type_dragonscale_cloak
		template = dragon_egg_template
		visuals = dragonscale_cloak_visual
		wealth = scope:wealth
		quality = scope:quality
		modifier = dragonscale_cloak_modifier
		save_scope_as = newly_created_artifact
		decaying = no
		history = {
			location = root.capital_province
			actor = root
			recipient = root
			type = created
		}
	}

	if = {
		limit = { exists = scope:dead_dragon }
		scope:newly_created_artifact = {
			if = {
				limit = { scope:dead_dragon = { has_artifact_feature = dragon_element_fire } }
				add_artifact_feature = dragon_element_fire
			}
			else_if = {
				limit = { scope:dead_dragon = { has_artifact_feature = dragon_element_water } }
				add_artifact_feature = dragon_element_water
			}
			else_if = {
				limit = { scope:dead_dragon = { has_artifact_feature = dragon_element_stone } }
				add_artifact_feature = dragon_element_stone
			}
		}
	}
}

create_dragon_fang_weapon_effect = {
	$OWNER$ = { save_scope_as = owner }
	set_artifact_rarity_illustrious = yes

	create_artifact = {
		name = artifact_dragon_fang_weapon_name
		description = artifact_dragon_fang_weapon_desc
		type = type_dragon_fang_weapon
		template = dragon_egg_template
		visuals = dragon_fang_weapon_visual
		wealth = scope:wealth
		quality = scope:quality
		modifier = dragon_fang_weapon_modifier
		save_scope_as = newly_created_artifact
		decaying = no
		history = {
			location = root.capital_province
			actor = root
			recipient = root
			type = created
		}
	}

	if = {
		limit = { exists = scope:dead_dragon }
		scope:newly_created_artifact = {
			if = {
				limit = { scope:dead_dragon = { has_artifact_feature = dragon_element_fire } }
				add_artifact_feature = dragon_element_fire
			}
			else_if = {
				limit = { scope:dead_dragon = { has_artifact_feature = dragon_element_water } }
				add_artifact_feature = dragon_element_water
			}
			else_if = {
				limit = { scope:dead_dragon = { has_artifact_feature = dragon_element_stone } }
				add_artifact_feature = dragon_element_stone
			}
		}
	}
}

# ═══════════════════════════════════════════
# DRAGON VARIABLE MANAGEMENT EFFECTS
# ═══════════════════════════════════════════

# Initialize dragon variables on any dragon artifact
initialize_dragon_variables_effect = {
	scope:dragon_artifact = {
		# Set unified age if not exists
		if = {
			limit = { NOT = { has_variable = dragon_age } }
			set_variable = {
				name = dragon_age
				value = 0
			}
		}
		
		# Set size based on age
		if = {
			limit = { NOT = { has_variable = dragon_size } }
			if = {
				limit = { var:dragon_age < 11 }
				set_variable = { name = dragon_size value = flag:tiny }
			}
			else_if = {
				limit = { var:dragon_age < 50 }
				set_variable = { name = dragon_size value = flag:small }
			}
			else_if = {
				limit = { var:dragon_age < 100 }
				set_variable = { name = dragon_size value = flag:medium }
			}
			else_if = {
				limit = { var:dragon_age < 200 }
				set_variable = { name = dragon_size value = flag:large }
			}
			else = {
				set_variable = { name = dragon_size value = flag:colossal }
			}
		}
		
		# Set default temperament if not exists
		if = {
			limit = { NOT = { has_variable = dragon_temperament } }
			random_list = {
				30 = { set_variable = { name = dragon_temperament value = flag:calm } }
				40 = { set_variable = { name = dragon_temperament value = flag:trained } }
				20 = { set_variable = { name = dragon_temperament value = flag:wild } }
				10 = { set_variable = { name = dragon_temperament value = flag:vicious } }
			}
		}
	}
}

# Update dragon size based on current age
update_dragon_size_effect = {
	scope:dragon_artifact = {
		if = {
			limit = { var:dragon_age < 11 }
			set_variable = { name = dragon_size value = flag:tiny }
		}
		else_if = {
			limit = { var:dragon_age < 50 }
			set_variable = { name = dragon_size value = flag:small }
		}
		else_if = {
			limit = { var:dragon_age < 100 }
			set_variable = { name = dragon_size value = flag:medium }
		}
		else_if = {
			limit = { var:dragon_age < 200 }
			set_variable = { name = dragon_size value = flag:large }
		}
		else = {
			set_variable = { name = dragon_size value = flag:colossal }
		}
	}
}

# Calculate death chance based on age (for Elder+)
# Returns a value in scope:death_chance
calculate_dragon_death_chance_effect = {
	scope:dragon_artifact = {
		set_local_variable = {
			name = death_chance
			value = 0
		}
		
		# Elder (151-250): 1-5% per year
		if = {
			limit = {
				var:dragon_age >= 151
				var:dragon_age < 251
			}
			change_local_variable = {
				name = death_chance
				add = 1
			}
			# Add 0.04% per year over 151
			change_local_variable = {
				name = death_chance
				add = {
					value = var:dragon_age
					subtract = 151
					multiply = 0.04
				}
			}
		}
		# Ancient (251-300): 5-15% per year
		else_if = {
			limit = {
				var:dragon_age >= 251
				var:dragon_age < 301
			}
			change_local_variable = {
				name = death_chance
				add = 5
			}
			change_local_variable = {
				name = death_chance
				add = {
					value = var:dragon_age
					subtract = 251
					multiply = 0.2
				}
			}
		}
		# Primordial (301-500): 15-50% per year
		else_if = {
			limit = {
				var:dragon_age >= 301
			}
			change_local_variable = {
				name = death_chance
				add = 15
			}
			change_local_variable = {
				name = death_chance
				add = {
					value = var:dragon_age
					subtract = 301
					multiply = 0.175
				}
			}
		}
		
		# Cap at 50%
		if = {
			limit = { local_var:death_chance > 50 }
			set_local_variable = {
				name = death_chance
				value = 50
			}
		}
	}
}

# Create Dragon hide when slaying them
create_artifact_dragon_hide_effect = {
	# Get the character the artifact is being made for.
	$OWNER$ = { save_scope_as = owner }
	$HUNTER$ = { save_scope_as = hunter }
	save_scope_value_as = { name = legendary value = yes }
	scope:owner = {
		set_variable = { name = animal_type value = flag:dragon days = 5 }
	}
	if = {
		limit = { exists = scope:adventurer }
		scope:adventurer = { save_scope_as = creator }
	}
	else = {
		scope:hunter = { save_scope_as = creator }
	}
	hidden_effect_new_object = {
		# Get artifact quality, wealth, and materials
		animal_artifact_wealth_quality_effect = yes
		get_animal_hunt_location_effect = yes
		scope:location = { add_to_list = artifact_material_sources }
		if = {
			limit = {
				NOT = { exists = scope:animal_hide_size }
			}
			save_scope_value_as = { name = animal_hide_size value = flag:big }
		}				
		create_artifact = {
			name = artifact_dragon_hide_name_legendary
			creator = scope:creator
			description = placeholder
			visuals = dragon_hide_big_visual
			type = dragon_hide_big
			modifier = artifact_placeholder_modifier
			wealth = scope:wealth
			quality = scope:quality
			save_scope_as = newly_created_artifact
		}
		scope:newly_created_artifact = {
			# Set grandeur
			add_scaled_artifact_modifier_grandeur_big_effect = yes
			# Set prestige
			add_scaled_artifact_modifier_prestige_effect = yes

			set_max_durability = 60
			set_variable = {
				name = adventure_artifact_location
				value = scope:owner.var:adventure_artifact_location
			}
			set_variable = {
				name = adventure_artifact_hunter
				value = scope:owner.var:adventure_artifact_hunter
			}
			if = {
				limit = {
					OR = {
						rarity = famed
						rarity = illustrious
					}
				}
				add_scaled_artifact_modifier_dynasty_prestige_effect = yes
			}
			remove_artifact_modifier = artifact_placeholder_modifier
			set_variable = {
				name = animal_type
				value = flag:dragon
			}
			# Set dragon element for visual display (if owner has dragon_type set)
			if = {
				limit = { scope:owner = { has_variable = dragon_type } }
				set_variable = {
					name = dragon_element
					value = scope:owner.var:dragon_type
				}
			}
			set_variable = {
				name = quality
				value = scope:quality
			}
			set_variable = {
				name = wealth
				value = scope:wealth
			}
			hunt_animal_artifact_modifier_selection_effect = yes
			if = {
				limit = { exists = scope:adventurer }
				set_artifact_name = artifact_dragon_hide_name_adventurer
			} else = {
				set_artifact_name = artifact_dragon_hide_name_legendary
				set_variable = { name = legendary }
				add_scaled_artifact_modifier_majesty_effect = yes
				add_scaled_artifact_modifier_combat_effect = yes
			}
			set_artifact_description = artifact_dragon_hide_desc
		}
		scope:owner = {
			remove_variable = adventure_artifact_location
			remove_variable = adventure_artifact_hunter
			# Destroy the spawned dragon reference artifact now that we've used its data
			if = {
				limit = { exists = var:last_spawned_dragon }
				destroy_artifact = var:last_spawned_dragon
				remove_variable = last_spawned_dragon
			}
		}
	}
}
# Create small Dragon hide when slaying smaller/younger dragons
create_artifact_dragon_hide_small_effect = {
	# Get the character the artifact is being made for.
	$OWNER$ = { save_scope_as = owner }
	$HUNTER$ = { save_scope_as = hunter }
	save_scope_value_as = { name = legendary value = yes }
	scope:owner = {
		set_variable = { name = animal_type value = flag:dragon days = 5 }
	}
	if = {
		limit = { exists = scope:adventurer }
		scope:adventurer = { save_scope_as = creator }
	}
	else = {
		scope:hunter = { save_scope_as = creator }
	}
	hidden_effect_new_object = {
		# Get artifact quality, wealth, and materials
		animal_artifact_wealth_quality_effect = yes
		get_animal_hunt_location_effect = yes
		scope:location = { add_to_list = artifact_material_sources }
		if = {
			limit = {
				NOT = { exists = scope:animal_hide_size }
			}
			save_scope_value_as = { name = animal_hide_size value = flag:small }
		}				
		create_artifact = {
			name = artifact_dragon_hide_name_legendary
			creator = scope:creator
			description = placeholder
			visuals = dragon_hide_visual
			type = dragon_hide
			modifier = artifact_placeholder_modifier
			wealth = scope:wealth
			quality = scope:quality
			save_scope_as = newly_created_artifact
		}
		scope:newly_created_artifact = {
			# Set grandeur (smaller for small hides)
			add_scaled_artifact_modifier_grandeur_small_effect = yes
			# Set prestige
			add_scaled_artifact_modifier_prestige_effect = yes

			set_max_durability = 50
			set_variable = {
				name = adventure_artifact_location
				value = scope:owner.var:adventure_artifact_location
			}
			set_variable = {
				name = adventure_artifact_hunter
				value = scope:owner.var:adventure_artifact_hunter
			}
			if = {
				limit = {
					OR = {
						rarity = famed
						rarity = illustrious
					}
				}
				add_scaled_artifact_modifier_dynasty_prestige_effect = yes
			}
			remove_artifact_modifier = artifact_placeholder_modifier
			set_variable = {
				name = animal_type
				value = flag:dragon
			}
			# Set dragon element for visual display (if owner has dragon_type set)
			if = {
				limit = { scope:owner = { has_variable = dragon_type } }
				set_variable = {
					name = dragon_element
					value = scope:owner.var:dragon_type
				}
			}
			set_variable = {
				name = quality
				value = scope:quality
			}
			set_variable = {
				name = wealth
				value = scope:wealth
			}
			hunt_animal_artifact_modifier_selection_effect = yes
			if = {
				limit = { exists = scope:adventurer }
				set_artifact_name = artifact_dragon_hide_name_adventurer
			} else = {
				set_artifact_name = artifact_dragon_hide_name_legendary
				set_variable = { name = legendary }
				add_scaled_artifact_modifier_majesty_effect = yes
				add_scaled_artifact_modifier_combat_effect = yes
			}
			set_artifact_description = artifact_dragon_hide_desc
		}
		scope:owner = {
			remove_variable = adventure_artifact_location
			remove_variable = adventure_artifact_hunter
			# Destroy the spawned dragon reference artifact now that we've used its data
			if = {
				limit = { exists = var:last_spawned_dragon }
				destroy_artifact = var:last_spawned_dragon
				remove_variable = last_spawned_dragon
			}
		}
	}
}